# Story 2.3: Laptop Battery Data Collection

## Status

Draft

## Story

**As a** developer,
**I want** a data collection module that retrieves laptop battery status via UPower,
**so that** the Devices panel can display battery information.

## Acceptance Criteria

1. `data_sources/devices.py` module exists with functions to collect battery/device metrics
2. Laptop battery status is retrieved via UPower D-Bus interface (or psutil.sensors_battery() as fallback)
3. Collected data includes: percentage, charging state (charging/discharging/full), time remaining estimate
4. Module maintains a history buffer of battery percentages for drain curve (last 60 data points)
5. Module handles systems without battery gracefully (returns None, doesn't crash)
6. Module includes unit tests with mocked D-Bus responses

## Tasks / Subtasks

- [ ] Create BatteryStatus and BatteryState data models (AC: 3)
  - [ ] Create src/monitor_dashboard/models/devices.py
  - [ ] Define BatteryState enum: CHARGING, DISCHARGING, FULL, UNKNOWN
  - [ ] Define BatteryStatus dataclass with all fields
  - [ ] Use @dataclass(frozen=True) for immutability
- [ ] Create DevicesCollector class (AC: 1, 2, 3)
  - [ ] Create src/monitor_dashboard/data_sources/devices.py
  - [ ] Implement collect_battery() -> BatteryStatus | None method
  - [ ] Primary: Use pydbus to query UPower D-Bus interface
  - [ ] Fallback: Use psutil.sensors_battery() if D-Bus unavailable
  - [ ] Parse UPower response into BatteryStatus
- [ ] Implement D-Bus retry logic (AC: 2, 5)
  - [ ] Implement retry with exponential backoff
  - [ ] Max retries: 2, initial delay: 100ms, backoff: 2x
  - [ ] Timeout: 1 second per call
  - [ ] Cache last known value during retries
- [ ] Handle no-battery systems (AC: 5)
  - [ ] Detect when UPower reports no battery device
  - [ ] Return None with is_present=False indicator
  - [ ] Do not log error (this is normal for desktops)
- [ ] Maintain battery history (AC: 4)
  - [ ] Add HistoryBuffer for battery percentages
  - [ ] Append battery percent on each collection
  - [ ] Provide method to get history: get_battery_history() -> list[float]
- [ ] Write unit tests (AC: 6)
  - [ ] Create tests/unit/data_sources/test_devices.py
  - [ ] Test BatteryStatus dataclass
  - [ ] Test collect_battery() with mocked D-Bus
  - [ ] Test fallback to psutil
  - [ ] Test no-battery handling
  - [ ] Test retry logic

## Dev Notes

**Data Models:**
```python
from dataclasses import dataclass
from enum import Enum

class BatteryState(Enum):
    CHARGING = "charging"
    DISCHARGING = "discharging"
    FULL = "full"
    UNKNOWN = "unknown"

@dataclass(frozen=True)
class BatteryStatus:
    """Laptop battery state."""
    percent: float              # 0-100
    state: BatteryState
    time_remaining: int | None  # Seconds until full/empty, None if unknown
    is_present: bool            # False if no battery detected
```

**UPower D-Bus Interface:**
```python
import pydbus
from gi.repository import GLib

UPOWER_BUS = "org.freedesktop.UPower"
UPOWER_PATH = "/org/freedesktop/UPower"
DEVICE_PATH = "/org/freedesktop/UPower/devices/DisplayDevice"

# UPower State values
UPOWER_STATE = {
    1: BatteryState.CHARGING,
    2: BatteryState.DISCHARGING,
    4: BatteryState.FULL,
}

class DevicesCollector:
    def __init__(self):
        self._bus = None
        self._battery_history = HistoryBuffer(60)
        self._cached_battery: BatteryStatus | None = None

    def _get_bus(self):
        if self._bus is None:
            self._bus = pydbus.SystemBus()
        return self._bus

    def collect_battery(self) -> BatteryStatus | None:
        try:
            device = self._get_bus().get(UPOWER_BUS, DEVICE_PATH)
            percent = device.Percentage
            state = UPOWER_STATE.get(device.State, BatteryState.UNKNOWN)
            time_to = device.TimeToEmpty if state == BatteryState.DISCHARGING else device.TimeToFull

            status = BatteryStatus(
                percent=percent,
                state=state,
                time_remaining=int(time_to) if time_to > 0 else None,
                is_present=True,
            )
            self._cached_battery = status
            self._battery_history.append(percent)
            return status

        except GLib.Error as e:
            if "No such object path" in str(e):
                # No battery - normal for desktops
                return BatteryStatus(percent=0, state=BatteryState.UNKNOWN,
                                    time_remaining=None, is_present=False)
            logger.warning(f"D-Bus error: {e}")
            return self._cached_battery  # Return cached

        except Exception as e:
            logger.warning(f"Battery collection failed: {e}")
            return self._fallback_psutil()

    def _fallback_psutil(self) -> BatteryStatus | None:
        """Fallback to psutil if D-Bus unavailable."""
        try:
            import psutil
            bat = psutil.sensors_battery()
            if bat is None:
                return BatteryStatus(percent=0, state=BatteryState.UNKNOWN,
                                    time_remaining=None, is_present=False)
            state = BatteryState.CHARGING if bat.power_plugged else BatteryState.DISCHARGING
            return BatteryStatus(
                percent=bat.percent,
                state=state,
                time_remaining=bat.secsleft if bat.secsleft > 0 else None,
                is_present=True,
            )
        except Exception as e:
            logger.warning(f"psutil fallback failed: {e}")
            return None

    def get_battery_history(self) -> list[float]:
        return self._battery_history.get_values()
```

**D-Bus Retry Configuration:**
```python
DBUS_RETRY_CONFIG = {
    "max_retries": 2,
    "initial_delay": 0.1,
    "backoff_factor": 2.0,
    "max_delay": 0.5,
    "timeout": 1.0,
}
```

### Testing

**Test Location:** tests/unit/data_sources/

**Testing Standards:**
- Framework: pytest 8.0.0
- Mocking: pytest-mock
- Run with: `pytest tests/unit/data_sources/test_devices.py`

**Test Patterns:**
```python
from unittest.mock import MagicMock, patch

def test_collect_battery_returns_status(mocker):
    """Test successful battery collection."""
    mock_device = MagicMock()
    mock_device.Percentage = 75.0
    mock_device.State = 2  # DISCHARGING
    mock_device.TimeToEmpty = 7200  # 2 hours

    mock_bus = MagicMock()
    mock_bus.get.return_value = mock_device
    mocker.patch('pydbus.SystemBus', return_value=mock_bus)

    collector = DevicesCollector()
    status = collector.collect_battery()

    assert status is not None
    assert status.percent == 75.0
    assert status.state == BatteryState.DISCHARGING
    assert status.time_remaining == 7200
    assert status.is_present is True

def test_collect_battery_no_battery(mocker):
    """Test handling of systems without battery."""
    mock_bus = MagicMock()
    mock_bus.get.side_effect = GLib.Error("No such object path")
    mocker.patch('pydbus.SystemBus', return_value=mock_bus)

    collector = DevicesCollector()
    status = collector.collect_battery()

    assert status is not None
    assert status.is_present is False

def test_battery_history_maintained():
    """Test that battery history is maintained."""
    collector = DevicesCollector()
    # Mock successful collections
    # ...
    history = collector.get_battery_history()
    assert len(history) > 0
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-17 | 0.1 | Initial story creation | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used

_To be filled by dev agent_

### Debug Log References

_To be filled by dev agent_

### Completion Notes List

_To be filled by dev agent_

### File List

_To be filled by dev agent_

---

## QA Results

_To be filled by QA agent_
