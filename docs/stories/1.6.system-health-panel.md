# Story 1.6: System Health Panel Display

## Status

Ready for Review

## Story

**As a** user,
**I want** to see real-time CPU usage, memory usage, and load average in the System Health panel,
**so that** I can monitor my system's performance at a glance.

## Acceptance Criteria

1. System Health panel displays CPU usage as a horizontal bar chart (percentage filled)
2. CPU history is shown as a simple rolling chart (last 60 seconds of data points)
3. Memory usage is displayed as a percentage bar with used/total values (e.g., "4.2 GB / 16 GB (26%)")
4. Load average displays 1, 5, and 15 minute values with labels
5. All values update at 1 Hz (1 refresh per second)
6. Panel includes LED-style status indicator (green if healthy, yellow/red if thresholds exceeded for future alerts)

## Tasks / Subtasks

- [x] Create HistoryBuffer utility (AC: 2)
  - [x] Create src/monitor_dashboard/utils/__init__.py
  - [x] Create src/monitor_dashboard/utils/history_buffer.py
  - [x] Implement circular buffer with fixed size (60 points default)
  - [x] Methods: append(), get_values(), clear()
  - [x] Write unit tests
- [x] Create SparklineWidget for history charts (AC: 2)
  - [x] Create src/monitor_dashboard/widgets/__init__.py
  - [x] Create src/monitor_dashboard/widgets/sparkline.py
  - [x] Accept list of float values (0-100)
  - [x] Render as text-based chart using Unicode block characters
  - [x] Scale to widget width
- [x] Create LEDIndicator widget (AC: 6)
  - [x] Create src/monitor_dashboard/widgets/led_indicator.py
  - [x] Display colored dot: ● green, ● yellow, ● red
  - [x] Accept status enum: OK, WARNING, CRITICAL
  - [x] Style with appropriate colors
- [x] Create formatting utilities (AC: 3)
  - [x] Create src/monitor_dashboard/utils/formatting.py
  - [x] Implement format_bytes(bytes) -> "4.2 GB"
  - [x] Implement format_percent(value) -> "26%"
  - [x] Write unit tests
- [x] Implement SystemHealthPanel display (AC: 1, 3, 4, 6)
  - [x] Update src/monitor_dashboard/panels/system_health.py
  - [x] Add update(metrics: SystemMetrics | None) method
  - [x] Display CPU bar with percentage
  - [x] Display CPU sparkline from history
  - [x] Display memory bar with formatted values
  - [x] Display load average with labels
  - [x] Add LED indicator to panel header
  - [x] Handle None metrics gracefully (show "N/A")
- [x] Integrate with app refresh loop (AC: 5)
  - [x] Create 1 Hz timer in MonitorDashboardApp
  - [x] Instantiate SystemHealthCollector
  - [x] Call collector.collect() every second
  - [x] Call panel.update(metrics) with collected data
  - [x] Update history buffer with CPU values

## Dev Notes

**Panel Layout:**
```
┌─ System Health ─────────────── ● ─┐
│ CPU:  [████████░░░░░░░░░░] 45%    │
│       ▁▂▃▄▅▆▇█▇▆▅▄▃▂▁▂▃▄▅  (60s) │
│                                   │
│ Memory: [██████░░░░░░░░░░] 38%    │
│         4.2 GB / 16.0 GB          │
│                                   │
│ Load: 1.5 (1m)  2.0 (5m)  1.8(15m)│
└───────────────────────────────────┘
```

**HistoryBuffer Pattern:**
```python
from collections import deque

class HistoryBuffer:
    """Fixed-size circular buffer for time-series data."""

    def __init__(self, maxlen: int = 60):
        self._buffer = deque(maxlen=maxlen)

    def append(self, value: float) -> None:
        self._buffer.append(value)

    def get_values(self) -> list[float]:
        return list(self._buffer)
```

**Sparkline Characters:**
```python
SPARK_CHARS = "▁▂▃▄▅▆▇█"  # Unicode block elements
# Map 0-100 to character index 0-7
```

**Refresh Loop Pattern:**
```python
class MonitorDashboardApp(App):
    def on_mount(self) -> None:
        self._collector = SystemHealthCollector()
        self._cpu_history = HistoryBuffer(60)
        self.set_interval(1.0, self._refresh_data)

    def _refresh_data(self) -> None:
        metrics = self._collector.collect()
        if metrics:
            self._cpu_history.append(metrics.cpu_percent)
        panel = self.query_one(SystemHealthPanel)
        panel.update(metrics, self._cpu_history.get_values())
```

**LED Status Logic (for future):**
- Green: CPU < 80%, Memory > 10% free
- Yellow: CPU 80-90% or Memory 5-10% free
- Red: CPU > 90% or Memory < 5% free

### Testing

**Test Location:** tests/unit/ and tests/integration/

**Testing Standards:**
- Framework: pytest 8.0.0
- Run with: `pytest tests/unit/test_history_buffer.py tests/unit/test_formatting.py`

**Test Cases:**
```python
# HistoryBuffer tests
def test_history_buffer_maintains_max_size():
    buf = HistoryBuffer(maxlen=5)
    for i in range(10):
        buf.append(i)
    assert len(buf.get_values()) == 5
    assert buf.get_values() == [5, 6, 7, 8, 9]

# Formatting tests
def test_format_bytes_gb():
    assert format_bytes(4_200_000_000) == "4.2 GB"

def test_format_bytes_mb():
    assert format_bytes(500_000_000) == "500.0 MB"
```

**Integration Tests:**
```python
async def test_system_health_panel_displays_cpu():
    async with app.run_test() as pilot:
        panel = app.query_one(SystemHealthPanel)
        panel.update(SystemMetrics(cpu_percent=50.0, ...))
        # Verify "50%" appears in panel content
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-17 | 0.1 | Initial story creation | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References

None

### Completion Notes List

- Created HistoryBuffer utility class using collections.deque for efficient circular buffer implementation
- Implemented Sparkline widget for rendering time-series data using Unicode block characters (▁▂▃▄▅▆▇█)
- Created LEDIndicator widget with CSS-based status coloring (green/yellow/red)
- Implemented formatting utilities: format_bytes() for human-readable sizes, format_percent() for percentages
- Updated SystemHealthPanel with update() method displaying CPU, memory, and load average
- Integrated ProgressBar widgets for visual CPU and memory usage display
- Added 1 Hz refresh loop to MonitorDashboardApp using set_interval()
- SystemHealthCollector integration with CPU history tracking (60-second buffer)
- All components validated with manual tests (pytest not available in environment)
- Updated pyproject.toml to replace unavailable pytest-textual-snapshot with pytest-asyncio

### File List

- src/monitor_dashboard/utils/__init__.py (new)
- src/monitor_dashboard/utils/history_buffer.py (new)
- src/monitor_dashboard/utils/formatting.py (new)
- src/monitor_dashboard/widgets/__init__.py (new)
- src/monitor_dashboard/widgets/sparkline.py (new)
- src/monitor_dashboard/widgets/led_indicator.py (new)
- src/monitor_dashboard/panels/system_health.py (modified)
- src/monitor_dashboard/app.py (modified)
- src/monitor_dashboard/styles/app.tcss (modified)
- tests/unit/test_history_buffer.py (new)
- tests/unit/test_formatting.py (new)
- pyproject.toml (modified)

---

## QA Results

_To be filled by QA agent_
