# Story 1.5: System Health Data Collection

## Status

Ready for Review

## Story

**As a** developer,
**I want** a data collection module that gathers CPU, memory, and load average metrics,
**so that** the System Health panel can display real system data.

## Acceptance Criteria

1. `data_sources/system_health.py` module exists with functions to collect metrics
2. CPU percentage is collected using `psutil.cpu_percent()` with per-CPU breakdown available
3. Memory usage is collected using `psutil.virtual_memory()` returning used/total/percent
4. Load average is collected using `psutil.getloadavg()` returning 1/5/15 minute values
5. Module includes unit tests verifying data collection returns expected types
6. Collection is designed to be called at 1Hz without blocking the UI

## Tasks / Subtasks

- [x] Create SystemMetrics data model (AC: 1, 2, 3, 4)
  - [x] Create src/monitor_dashboard/models/__init__.py
  - [x] Create src/monitor_dashboard/models/metrics.py
  - [x] Define SystemMetrics dataclass with all fields
  - [x] Use @dataclass(frozen=True) for immutability
- [x] Create SystemHealthCollector class (AC: 1, 2, 3, 4)
  - [x] Create src/monitor_dashboard/data_sources/__init__.py
  - [x] Create src/monitor_dashboard/data_sources/system_health.py
  - [x] Implement collect() -> SystemMetrics | None method
  - [x] Collect CPU percent with interval=None (non-blocking)
  - [x] Collect per-core CPU percentages
  - [x] Collect memory via psutil.virtual_memory()
  - [x] Collect load average via psutil.getloadavg()
  - [x] Handle exceptions gracefully, return None on failure
- [x] Ensure non-blocking collection (AC: 6)
  - [x] Use psutil.cpu_percent(interval=None) for instant reading
  - [x] Document that first call may return 0.0 (requires previous call)
  - [x] Collection should complete in <50ms
- [x] Write unit tests (AC: 5)
  - [x] Create tests/unit/data_sources/__init__.py
  - [x] Create tests/unit/data_sources/test_system_health.py
  - [x] Test SystemMetrics dataclass fields
  - [x] Test collect() returns SystemMetrics with valid types
  - [x] Test collect() handles psutil exceptions
  - [x] Mock psutil for deterministic testing

## Dev Notes

**SystemMetrics Data Model:**
```python
from dataclasses import dataclass
from datetime import datetime

@dataclass(frozen=True)
class SystemMetrics:
    """Snapshot of system health metrics."""
    timestamp: datetime
    cpu_percent: float          # 0-100
    cpu_per_core: tuple[float, ...]  # Per-core percentages
    memory_used: int            # Bytes
    memory_total: int           # Bytes
    memory_percent: float       # 0-100
    load_avg: tuple[float, float, float]  # 1, 5, 15 minute
```

**SystemHealthCollector Pattern:**
```python
import psutil
from datetime import datetime
import logging

logger = logging.getLogger(__name__)

class SystemHealthCollector:
    """Collects CPU, memory, and load average metrics."""

    def collect(self) -> SystemMetrics | None:
        """Gather current system health data.

        Returns:
            SystemMetrics with current values, or None on failure.
        """
        try:
            cpu = psutil.cpu_percent(interval=None)
            cpu_per_core = tuple(psutil.cpu_percent(interval=None, percpu=True))
            mem = psutil.virtual_memory()
            load = psutil.getloadavg()

            return SystemMetrics(
                timestamp=datetime.now(),
                cpu_percent=cpu,
                cpu_per_core=cpu_per_core,
                memory_used=mem.used,
                memory_total=mem.total,
                memory_percent=mem.percent,
                load_avg=load,
            )
        except Exception as e:
            logger.warning(f"Failed to collect system metrics: {e}")
            return None
```

**psutil Notes:**
- `cpu_percent(interval=None)` returns instant value based on previous call
- First call after import may return 0.0 (no previous measurement)
- `virtual_memory()` returns named tuple with used, total, percent, available, etc.
- `getloadavg()` returns (1min, 5min, 15min) tuple

**Coding Standards:**
- Type hints on all methods
- Google-style docstrings
- Use logging, never print()
- Return None on error, don't raise exceptions to UI

### Testing

**Test Location:** tests/unit/data_sources/

**Testing Standards:**
- Framework: pytest 8.0.0
- Mocking: pytest-mock
- Run with: `pytest tests/unit/data_sources/test_system_health.py`

**Test Patterns:**
```python
import pytest
from unittest.mock import MagicMock, patch

def test_collect_returns_system_metrics(mocker):
    """Test that collect() returns valid SystemMetrics."""
    mocker.patch('psutil.cpu_percent', return_value=45.5)
    mocker.patch('psutil.virtual_memory', return_value=MagicMock(
        used=4_000_000_000,
        total=16_000_000_000,
        percent=25.0
    ))
    mocker.patch('psutil.getloadavg', return_value=(1.5, 2.0, 1.8))

    collector = SystemHealthCollector()
    metrics = collector.collect()

    assert metrics is not None
    assert metrics.cpu_percent == 45.5
    assert metrics.memory_percent == 25.0
    assert metrics.load_avg == (1.5, 2.0, 1.8)

def test_collect_handles_exception(mocker):
    """Test graceful handling when psutil fails."""
    mocker.patch('psutil.cpu_percent', side_effect=Exception("mock error"))

    collector = SystemHealthCollector()
    metrics = collector.collect()

    assert metrics is None
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-17 | 0.1 | Initial story creation | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References

None

### Completion Notes List

- Created SystemMetrics frozen dataclass with all required fields
- Implemented SystemHealthCollector with collect() method
- Used psutil.cpu_percent(interval=None) for non-blocking CPU collection
- Collected per-core CPU percentages via percpu=True
- Collected memory metrics via psutil.virtual_memory()
- Collected load average via psutil.getloadavg()
- Added exception handling returning None on failure
- Created comprehensive unit tests with mocked psutil
- Tests verify dataclass fields, valid types, exception handling, and non-blocking behavior
- All code validated with syntax checks and import tests

### File List

- src/monitor_dashboard/models/__init__.py
- src/monitor_dashboard/models/metrics.py
- src/monitor_dashboard/data_sources/__init__.py
- src/monitor_dashboard/data_sources/system_health.py
- tests/unit/data_sources/__init__.py
- tests/unit/data_sources/test_system_health.py

---

## QA Results

_To be filled by QA agent_
