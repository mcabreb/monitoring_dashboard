# Story 2.6: Memory History Graph

## Status

Draft

## Story

**As a** user,
**I want** to see memory usage history similar to CPU history,
**so that** I can track memory trends over time (useful for detecting leaks).

## Acceptance Criteria

1. System Health panel includes memory history graph alongside CPU history
2. Memory history shows last 60 seconds of data points as a rolling line chart
3. Graph uses same visual style as CPU history for consistency
4. History data is maintained in memory buffer, collected at 1Hz
5. Expanded view shows longer history (more data points visible)

## Tasks / Subtasks

- [ ] Add memory history buffer (AC: 4)
  - [ ] Create HistoryBuffer instance for memory in app
  - [ ] Append memory_percent on each refresh cycle
  - [ ] Maintain 60 data points for normal view
  - [ ] Maintain 120 data points for expanded view
- [ ] Update SystemHealthPanel layout (AC: 1, 2)
  - [ ] Add memory sparkline widget below memory bar
  - [ ] Position similar to CPU sparkline
  - [ ] Label as memory history
- [ ] Apply consistent styling (AC: 3)
  - [ ] Use same SparklineWidget as CPU
  - [ ] Use same height and character set
  - [ ] Consider different color/shade to distinguish from CPU
- [ ] Update panel update method (AC: 2, 4)
  - [ ] Extend update() signature to include memory_history
  - [ ] Or pass both histories in a single data structure
  - [ ] Update sparkline with memory history data
- [ ] Handle expanded view (AC: 5)
  - [ ] Pass longer history (120 points) when expanded
  - [ ] SparklineWidget should scale to available width
  - [ ] Consider showing both CPU and memory in expanded view

## Dev Notes

**Updated Panel Layout:**
```
┌─ System Health ─────────────── ● ─┐
│ CPU:  [████████░░░░░░░░░░] 45%    │
│       ▁▂▃▄▅▆▇█▇▆▅▄▃▂▁▂▃▄▅  (60s) │
│                                   │
│ Memory: [██████░░░░░░░░░░] 38%    │
│         ▁▁▂▂▃▃▄▄▃▃▂▂▁▁▂▂▃  (60s) │
│         4.2 GB / 16.0 GB          │
│                                   │
│ Load: 1.5 (1m)  2.0 (5m)  1.8(15m)│
└───────────────────────────────────┘
```

**History Buffers in App:**
```python
class MonitorDashboardApp(App):
    def on_mount(self) -> None:
        self._system_collector = SystemHealthCollector()
        self._cpu_history = HistoryBuffer(120)    # Extra for expanded
        self._memory_history = HistoryBuffer(120)
        self.set_interval(1.0, self._refresh_data)

    def _refresh_data(self) -> None:
        metrics = self._system_collector.collect()
        if metrics:
            self._cpu_history.append(metrics.cpu_percent)
            self._memory_history.append(metrics.memory_percent)

        panel = self.query_one(SystemHealthPanel)
        is_expanded = isinstance(self.screen, ExpandedPanelScreen)
        points = 120 if is_expanded else 60

        panel.update(
            metrics,
            cpu_history=self._cpu_history.get_values()[-points:],
            memory_history=self._memory_history.get_values()[-points:],
        )
```

**Updated Panel Update Method:**
```python
class SystemHealthPanel(BasePanel):
    def update(
        self,
        metrics: SystemMetrics | None,
        cpu_history: list[float] | None = None,
        memory_history: list[float] | None = None,
    ) -> None:
        # Update CPU section
        if metrics:
            self._cpu_bar.update(metrics.cpu_percent / 100)
            self._cpu_value.update(f"{metrics.cpu_percent:.0f}%")

        if cpu_history:
            self._cpu_sparkline.update(cpu_history)

        # Update Memory section
        if metrics:
            self._memory_bar.update(metrics.memory_percent / 100)
            self._memory_value.update(
                f"{format_bytes(metrics.memory_used)} / "
                f"{format_bytes(metrics.memory_total)}"
            )

        if memory_history:
            self._memory_sparkline.update(memory_history)

        # Update Load section
        if metrics:
            self._load_display.update(
                f"Load: {metrics.load_avg[0]:.1f} (1m)  "
                f"{metrics.load_avg[1]:.1f} (5m)  "
                f"{metrics.load_avg[2]:.1f} (15m)"
            )
```

**Distinguishing CPU vs Memory Sparklines:**
- Option 1: Different Unicode character sets
- Option 2: Label each sparkline (already doing this)
- Option 3: Slight color variation (CPU blue-ish, Memory green-ish)

For GEM aesthetic, keep both monochrome but clearly labeled.

**Memory Leak Detection Use Case:**
A steadily rising memory sparkline over time indicates potential memory leak. The 60-second view gives immediate feedback; expanded 120-second view shows longer-term trends.

### Testing

**Test Location:** tests/integration/

**Testing Standards:**
- Framework: pytest with textual pilot API
- Run with: `pytest tests/integration/test_panels.py`

**Test Cases:**
```python
async def test_system_health_panel_shows_memory_history():
    async with app.run_test() as pilot:
        panel = app.query_one(SystemHealthPanel)
        metrics = SystemMetrics(
            cpu_percent=45.0,
            memory_percent=38.0,
            # ... other fields
        )
        memory_history = [35.0, 36.0, 37.0, 38.0]

        panel.update(metrics, cpu_history=[45.0], memory_history=memory_history)

        # Verify memory sparkline exists
        sparkline = panel.query_one("#memory-sparkline")
        assert sparkline is not None

def test_history_buffer_appends_memory():
    """Test that memory history is collected."""
    buf = HistoryBuffer(60)
    for i in range(10):
        buf.append(30.0 + i)

    values = buf.get_values()
    assert len(values) == 10
    assert values[-1] == 39.0

async def test_expanded_view_shows_more_memory_history():
    async with app.run_test() as pilot:
        # Populate 120 points of history
        # Expand panel
        # Verify sparkline shows more points
        pass
```

**Manual Verification:**
- Launch app and observe memory sparkline
- Watch for several minutes to see history accumulate
- Expand System Health panel to see longer history
- Open memory-intensive app and observe spike in graph

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-17 | 0.1 | Initial story creation | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used

_To be filled by dev agent_

### Debug Log References

_To be filled by dev agent_

### Completion Notes List

_To be filled by dev agent_

### File List

_To be filled by dev agent_

---

## QA Results

_To be filled by QA agent_
