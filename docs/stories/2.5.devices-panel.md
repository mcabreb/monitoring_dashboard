# Story 2.5: Devices Panel Display

## Status

Approved

## Story

**As a** user,
**I want** to see laptop battery status and connected Bluetooth devices in the Devices panel,
**so that** I can monitor battery levels across all my devices.

## Acceptance Criteria

1. Laptop battery section shows: percentage bar, charging state icon, time remaining estimate
2. Laptop battery includes a drain curve visualization (simple line chart of last 60 readings)
3. Bluetooth devices section lists each device with: name, type icon, battery percentage bar
4. Devices without battery show "Battery: N/A" instead of a bar
5. Panel shows "No Bluetooth devices connected" when list is empty
6. Panel shows "No battery detected" if running on desktop without battery
7. LED status indicator reflects worst battery status (laptop or any BT device <20%)

## Tasks / Subtasks

- [ ] Create battery display section (AC: 1, 6)
  - [ ] Update src/monitor_dashboard/panels/devices.py
  - [ ] Add laptop battery section with percentage bar
  - [ ] Display charging state icon: ðŸ”Œ (charging), ðŸ”‹ (discharging), âœ“ (full)
  - [ ] Show time remaining: "2h 15m remaining" or "1h 30m to full"
  - [ ] Show "No battery detected" when battery is None/not present
- [ ] Add battery drain curve visualization (AC: 2)
  - [ ] Reuse SparklineWidget from Story 1.6
  - [ ] Display last 60 readings from battery history
  - [ ] Show trend (draining vs charging visible in curve)
- [ ] Create Bluetooth devices section (AC: 3, 4, 5)
  - [ ] Add scrollable list of Bluetooth devices
  - [ ] Display type icon: ðŸŽ§ (headphones), ðŸ–±ï¸ (mouse), âŒ¨ï¸ (keyboard), ðŸŽ® (gamepad), ðŸ“± (other)
  - [ ] Display device name
  - [ ] Display battery bar or "Battery: N/A"
  - [ ] Show "No Bluetooth devices connected" when list is empty
- [ ] Implement update method (AC: 1, 2, 3)
  - [ ] Add update(battery: BatteryStatus | None, devices: list[BluetoothDevice]) method
  - [ ] Add update_history(history: list[float]) method for drain curve
  - [ ] Handle None/empty inputs gracefully
- [ ] Implement LED status indicator (AC: 7)
  - [ ] Calculate worst status from laptop battery and all BT devices
  - [ ] Green: all batteries >20%
  - [ ] Yellow: any battery 10-20%
  - [ ] Red: any battery <10%
  - [ ] Update LED on each refresh
- [ ] Integrate with app refresh loop
  - [ ] Call devices_collector.collect_battery()
  - [ ] Call devices_collector.collect_bluetooth()
  - [ ] Call devices_collector.get_battery_history()
  - [ ] Pass all data to panel.update()

## Dev Notes

**Panel Layout:**
```
â”Œâ”€ Devices â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â— â”€â”
â”‚ ðŸ”‹ Laptop Battery                 â”‚
â”‚ [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘] 62%        â”‚
â”‚ â–â–‚â–ƒâ–„â–…â–†â–‡â–ˆâ–‡â–†â–…â–„â–ƒâ–‚â–â–‚â–ƒ  Discharging    â”‚
â”‚ 3h 45m remaining                  â”‚
â”‚                                   â”‚
â”‚ ðŸ“¶ Bluetooth Devices              â”‚
â”‚ ðŸŽ§ Sony WH-1000XM4    [â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘] 45%â”‚
â”‚ ðŸ–±ï¸ MX Master 3        [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ] 85%â”‚
â”‚ âŒ¨ï¸ Keychron K2        Battery: N/Aâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Charging State Icons:**
```python
BATTERY_ICONS = {
    BatteryState.CHARGING: "ðŸ”Œ",
    BatteryState.DISCHARGING: "ðŸ”‹",
    BatteryState.FULL: "âœ“",
    BatteryState.UNKNOWN: "?",
}

DEVICE_TYPE_ICONS = {
    DeviceType.HEADPHONES: "ðŸŽ§",
    DeviceType.MOUSE: "ðŸ–±ï¸",
    DeviceType.KEYBOARD: "âŒ¨ï¸",
    DeviceType.GAMEPAD: "ðŸŽ®",
    DeviceType.OTHER: "ðŸ“±",
}
```

**Time Formatting:**
```python
def format_time_remaining(seconds: int | None, is_charging: bool) -> str:
    if seconds is None:
        return "Time unknown"
    hours, remainder = divmod(seconds, 3600)
    minutes = remainder // 60
    if is_charging:
        return f"{hours}h {minutes}m to full"
    return f"{hours}h {minutes}m remaining"
```

**DevicesPanel Structure:**
```python
class DevicesPanel(BasePanel):
    BORDER_TITLE = "Devices"

    def compose(self):
        yield Container(
            Static("ðŸ”‹ Laptop Battery", id="battery-header"),
            ProgressBar(id="battery-bar"),
            Sparkline(id="battery-curve"),
            Static("", id="battery-status"),
            id="battery-section"
        )
        yield Container(
            Static("ðŸ“¶ Bluetooth Devices", id="bt-header"),
            VerticalScroll(id="bt-list"),
            id="bluetooth-section"
        )

    def update(
        self,
        battery: BatteryStatus | None,
        devices: list[BluetoothDevice],
        history: list[float] | None = None
    ) -> None:
        self._update_battery_section(battery, history)
        self._update_bluetooth_section(devices)
        self._update_led_status(battery, devices)
```

**LED Status Calculation:**
```python
def _calculate_worst_status(
    self,
    battery: BatteryStatus | None,
    devices: list[BluetoothDevice]
) -> LEDStatus:
    all_percents = []

    if battery and battery.is_present:
        all_percents.append(battery.percent)

    for device in devices:
        if device.battery_percent is not None:
            all_percents.append(device.battery_percent)

    if not all_percents:
        return LEDStatus.OK

    worst = min(all_percents)
    if worst < 10:
        return LEDStatus.CRITICAL
    elif worst < 20:
        return LEDStatus.WARNING
    return LEDStatus.OK
```

### Testing

**Test Location:** tests/integration/

**Testing Standards:**
- Framework: pytest with textual pilot API
- Run with: `pytest tests/integration/test_panels.py`

**Test Cases:**
```python
async def test_devices_panel_displays_battery():
    async with app.run_test() as pilot:
        panel = app.query_one(DevicesPanel)
        battery = BatteryStatus(
            percent=62.0,
            state=BatteryState.DISCHARGING,
            time_remaining=13500,
            is_present=True
        )
        panel.update(battery, [], [60, 61, 62])

        content = str(panel.render())
        assert "62%" in content
        assert "remaining" in content

async def test_devices_panel_no_battery():
    async with app.run_test() as pilot:
        panel = app.query_one(DevicesPanel)
        battery = BatteryStatus(percent=0, state=BatteryState.UNKNOWN,
                               time_remaining=None, is_present=False)
        panel.update(battery, [])

        content = str(panel.render())
        assert "No battery detected" in content

async def test_devices_panel_bluetooth_devices():
    async with app.run_test() as pilot:
        panel = app.query_one(DevicesPanel)
        devices = [
            BluetoothDevice(name="Sony WH-1000XM4", address="xx:xx",
                           device_type=DeviceType.HEADPHONES,
                           battery_percent=45, is_connected=True)
        ]
        panel.update(None, devices)

        content = str(panel.render())
        assert "Sony WH-1000XM4" in content
        assert "45%" in content
```

**Manual Verification:**
- Test with laptop (battery present)
- Test on desktop (no battery)
- Connect Bluetooth devices and verify display
- Verify drain curve updates over time

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-17 | 0.1 | Initial story creation | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used

_To be filled by dev agent_

### Debug Log References

_To be filled by dev agent_

### Completion Notes List

_To be filled by dev agent_

### File List

_To be filled by dev agent_

---

## QA Results

_To be filled by QA agent_
