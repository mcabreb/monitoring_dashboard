# Story 3.3: Clipboard Copy for Logs

## Status

Approved

## Story

**As a** user,
**I want** to copy log entries to the clipboard,
**so that** I can paste them elsewhere for sharing or further analysis.

## Acceptance Criteria

1. Pressing 'c' when Logs panel is focused copies visible log entries to clipboard
2. Pressing 'C' (shift+c) copies all buffered entries (up to 100) to clipboard
3. Copied text includes timestamps and full messages (not truncated)
4. Visual feedback confirms copy action (brief flash or status message)
5. Clipboard integration uses pyperclip library
6. Graceful handling if clipboard is unavailable (show error message, don't crash)

## Tasks / Subtasks

- [ ] Create clipboard utility wrapper (AC: 5, 6)
  - [ ] Create src/monitor_dashboard/utils/clipboard.py
  - [ ] Implement copy_to_clipboard(text: str) -> bool
  - [ ] Use pyperclip.copy() internally
  - [ ] Handle pyperclip exceptions gracefully
  - [ ] Return True on success, False on failure
- [ ] Add key bindings to LogsPanel (AC: 1, 2)
  - [ ] Add 'c' binding for copy_visible action
  - [ ] Add 'C' binding for copy_all action
  - [ ] Bindings only active when Logs panel is focused
- [ ] Implement copy_visible method (AC: 1, 3)
  - [ ] Get currently visible entries (last 30)
  - [ ] Format entries with full timestamps and messages
  - [ ] Call clipboard utility
  - [ ] Show feedback on success/failure
- [ ] Implement copy_all method (AC: 2, 3)
  - [ ] Get all buffered entries (up to 100)
  - [ ] Format entries with full timestamps and messages
  - [ ] Call clipboard utility
  - [ ] Show feedback on success/failure
- [ ] Format log entries for clipboard (AC: 3)
  - [ ] Include ISO timestamp (not just HH:MM:SS)
  - [ ] Include severity level
  - [ ] Include full message (not truncated)
  - [ ] One entry per line
- [ ] Implement visual feedback (AC: 4)
  - [ ] Brief flash on panel border
  - [ ] Or show status message "Copied N entries to clipboard"
  - [ ] Feedback should auto-dismiss after 1-2 seconds
- [ ] Handle clipboard errors (AC: 6)
  - [ ] Catch pyperclip.PyperclipException
  - [ ] Show error message to user
  - [ ] Log warning with details
  - [ ] Do not crash the application

## Dev Notes

**Clipboard Utility:**
```python
import logging
import pyperclip

logger = logging.getLogger(__name__)

class ClipboardError(Exception):
    """Raised when clipboard operation fails."""
    pass

def copy_to_clipboard(text: str) -> None:
    """Copy text to system clipboard.

    Args:
        text: Text to copy.

    Raises:
        ClipboardError: If clipboard is unavailable.
    """
    try:
        pyperclip.copy(text)
    except pyperclip.PyperclipException as e:
        logger.warning(f"Clipboard unavailable: {e}")
        raise ClipboardError(
            "Clipboard not available. "
            "Install xclip (Linux) or check terminal permissions."
        ) from e
```

**Key Bindings:**
```python
class LogsPanel(BasePanel):
    BINDINGS = [
        Binding("c", "copy_visible", "Copy Visible"),
        Binding("C", "copy_all", "Copy All"),
    ]

    def action_copy_visible(self) -> None:
        """Copy visible log entries to clipboard."""
        entries = self._entries[-30:]  # Visible entries
        self._copy_entries(entries, "visible")

    def action_copy_all(self) -> None:
        """Copy all buffered log entries to clipboard."""
        self._copy_entries(self._entries, "all")
```

**Entry Formatting for Clipboard:**
```python
def _format_entries_for_clipboard(self, entries: list[LogEntry]) -> str:
    """Format log entries for clipboard copy."""
    lines = []
    for entry in entries:
        # Full ISO timestamp
        ts = entry.timestamp.isoformat()
        # Severity
        sev = entry.severity.value.upper()
        # Full message (not truncated)
        msg = entry.message

        lines.append(f"{ts} [{sev}] {msg}")

    return "\n".join(lines)
```

**Copy with Feedback:**
```python
def _copy_entries(self, entries: list[LogEntry], description: str) -> None:
    """Copy entries to clipboard with visual feedback."""
    if not entries:
        self.notify("No entries to copy", severity="warning")
        return

    text = self._format_entries_for_clipboard(entries)

    try:
        copy_to_clipboard(text)
        self.notify(f"Copied {len(entries)} {description} entries", severity="information")
        self._flash_border()
    except ClipboardError as e:
        self.notify(str(e), severity="error")
```

**Visual Feedback Options:**

1. **Textual Notify:** Use `self.app.notify()` for toast-style message
2. **Border Flash:** Briefly change border color
3. **Status Line:** Update a status widget in the panel

```python
def _flash_border(self) -> None:
    """Briefly highlight border to confirm action."""
    self.add_class("flash")
    self.set_timer(0.5, lambda: self.remove_class("flash"))

# CSS:
# LogsPanel.flash {
#     border: double green;
# }
```

**pyperclip Requirements:**
- Linux: Requires `xclip` or `xsel` installed
- Wayland: May require `wl-clipboard`
- Falls back to various methods

### Testing

**Test Location:** tests/unit/ and tests/integration/

**Testing Standards:**
- Framework: pytest 8.0.0
- Run with: `pytest tests/unit/test_clipboard.py tests/integration/test_panels.py`

**Test Cases:**
```python
# Unit tests
def test_copy_to_clipboard_success(mocker):
    """Test successful clipboard copy."""
    mocker.patch('pyperclip.copy')

    copy_to_clipboard("test text")

    pyperclip.copy.assert_called_once_with("test text")

def test_copy_to_clipboard_raises_on_error(mocker):
    """Test that clipboard errors are raised."""
    mocker.patch('pyperclip.copy', side_effect=pyperclip.PyperclipException("no clipboard"))

    with pytest.raises(ClipboardError):
        copy_to_clipboard("test text")

# Integration tests
async def test_logs_panel_c_copies_visible(mocker):
    async with app.run_test() as pilot:
        mock_copy = mocker.patch('monitor_dashboard.utils.clipboard.copy_to_clipboard')

        panel = app.query_one(LogsPanel)
        panel.focus()
        # Populate with entries
        panel.update([...])

        await pilot.press("c")

        mock_copy.assert_called_once()
        # Verify only visible entries were copied

async def test_logs_panel_C_copies_all(mocker):
    async with app.run_test() as pilot:
        mock_copy = mocker.patch('monitor_dashboard.utils.clipboard.copy_to_clipboard')

        panel = app.query_one(LogsPanel)
        panel.focus()
        # Populate with 100 entries
        panel.update([...] * 100)

        await pilot.press("C")

        mock_copy.assert_called_once()
        # Verify all entries were copied
```

**Manual Verification:**
- Focus Logs panel
- Press 'c' and verify visible entries in clipboard
- Press 'C' and verify all entries in clipboard
- Verify feedback message appears
- Test without xclip installed (should show error)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-17 | 0.1 | Initial story creation | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used

_To be filled by dev agent_

### Debug Log References

_To be filled by dev agent_

### Completion Notes List

_To be filled by dev agent_

### File List

_To be filled by dev agent_

---

## QA Results

_To be filled by QA agent_
