# Story 2.2: Storage Panel Display

## Status

Ready for Review

Approved

## Story

**As a** user,
**I want** to see disk usage for all partitions and mounted volumes in the Storage panel,
**so that** I can monitor available space across my system.

## Acceptance Criteria

1. Storage panel displays a percentage bar for each mounted partition
2. Each bar shows: mount point, used/total space, percentage (e.g., "/home - 120 GB / 500 GB (24%)")
3. Bars use color coding: green (<70%), yellow (70-90%), red (>90%)
4. Partitions are sorted by mount point (/ first, then alphabetically)
5. Panel scrolls if there are more partitions than fit in the panel height
6. LED status indicator shows worst-case status (red if any disk >90%)

## Tasks / Subtasks

- [x] Create themed ProgressBar widget (AC: 1, 3)
  - [ ] Create src/monitor_dashboard/widgets/progress_bar.py
  - [ ] Extend or wrap textual ProgressBar
  - [ ] Accept color parameter or auto-color based on percentage
  - [ ] Implement threshold-based coloring: green <70, yellow 70-90, red >90
- [x] Update StoragePanel with disk display (AC: 1, 2, 4)
  - [ ] Update src/monitor_dashboard/panels/storage.py
  - [ ] Add update(disks: list[DiskInfo]) method
  - [ ] Render each disk as: label + progress bar
  - [ ] Format label: "{mount_point} - {used} / {total} ({percent}%)"
  - [ ] Use formatting utilities for bytes (GB, MB)
  - [ ] Sort by mount point (already sorted from collector)
- [x] Implement scrolling for many partitions (AC: 5)
  - [ ] Use textual ListView or ScrollableContainer
  - [ ] Arrow keys scroll within panel when focused
  - [ ] Show scroll indicator if content exceeds view
- [x] Implement LED status indicator (AC: 6)
  - [ ] Calculate worst disk status from all partitions
  - [ ] Green: all disks <70%
  - [ ] Yellow: any disk 70-90%
  - [ ] Red: any disk >90%
  - [ ] Update LED on each refresh
- [x] Integrate with app refresh loop (AC: 1)
  - [ ] Instantiate StorageCollector in app
  - [ ] Call collector.collect() in refresh loop
  - [ ] Call storage_panel.update(disks) with collected data
- [x] Handle empty/None data gracefully (AC: 1)
  - [ ] Display "No partitions found" if list is empty
  - [ ] Handle None input without crashing

## Dev Notes

**Panel Layout:**
```
┌─ Storage ───────────────────── ● ─┐
│ /      [████████░░░░░░░] 52%      │
│        260 GB / 500 GB            │
│                                   │
│ /home  [██████░░░░░░░░░] 38%      │
│        380 GB / 1.0 TB            │
│                                   │
│ /boot  [██░░░░░░░░░░░░░] 12%      │
│        120 MB / 1.0 GB            │
└───────────────────────────────────┘
```

**Color Thresholds:**
```python
def get_disk_status(percent: float) -> LEDStatus:
    if percent >= 90:
        return LEDStatus.CRITICAL  # Red
    elif percent >= 70:
        return LEDStatus.WARNING   # Yellow
    return LEDStatus.OK            # Green
```

**Progress Bar Styling (CSS):**
```css
.disk-bar-ok {
    bar-color: green;
}

.disk-bar-warning {
    bar-color: yellow;
}

.disk-bar-critical {
    bar-color: red;
}
```

**Scrollable Container Pattern:**
```python
from textual.containers import VerticalScroll

class StoragePanel(BasePanel):
    def compose(self):
        yield VerticalScroll(id="disk-list")

    def update(self, disks: list[DiskInfo]) -> None:
        container = self.query_one("#disk-list")
        container.remove_children()

        for disk in disks:
            container.mount(DiskEntry(disk))

        # Update LED
        self._update_led_status(disks)
```

**Formatting Examples:**
```python
format_bytes(260_000_000_000) -> "260 GB"
format_bytes(380_000_000_000) -> "380 GB"
format_bytes(1_000_000_000_000) -> "1.0 TB"
```

### Testing

**Test Location:** tests/integration/

**Testing Standards:**
- Framework: pytest with textual pilot API
- Run with: `pytest tests/integration/test_panels.py`

**Test Cases:**
```python
async def test_storage_panel_displays_disks():
    async with app.run_test() as pilot:
        panel = app.query_one(StoragePanel)
        disks = [
            DiskInfo(mount_point='/', device='/dev/sda1', fs_type='ext4',
                    total=500_000_000_000, used=260_000_000_000,
                    free=240_000_000_000, percent=52.0),
        ]
        panel.update(disks)

        # Verify content appears
        content = str(panel.render())
        assert "/" in content
        assert "52%" in content

async def test_storage_panel_led_reflects_worst_status():
    async with app.run_test() as pilot:
        panel = app.query_one(StoragePanel)
        disks = [
            DiskInfo(..., percent=50.0),  # OK
            DiskInfo(..., percent=95.0),  # Critical
        ]
        panel.update(disks)

        led = panel.query_one(LEDIndicator)
        assert led.status == LEDStatus.CRITICAL
```

**Manual Verification:**
- Launch app with multiple partitions
- Verify each partition shows with correct values
- Verify color coding matches thresholds
- Test scrolling if many partitions exist

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-17 | 0.1 | Initial story creation | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used

_To be filled by dev agent_

### Debug Log References

_To be filled by dev agent_

### Completion Notes List

_To be filled by dev agent_

### File List

_To be filled by dev agent_

---

## QA Results

_To be filled by QA agent_
