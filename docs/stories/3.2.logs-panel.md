# Story 3.2: Logs Panel Display

## Status

Approved

## Story

**As a** user,
**I want** to see recent system logs with severity highlighting in the Logs panel,
**so that** I can quickly spot errors and warnings.

## Acceptance Criteria

1. Logs panel displays the 30 most recent dmesg entries
2. Each entry shows: timestamp (HH:MM:SS), severity indicator, message (truncated if needed)
3. Entries are color-coded by severity: red (error/critical), yellow (warning), white (info/notice), gray (debug)
4. Panel supports scrolling with arrow keys to view up to 100 entries
5. New entries appear at the bottom, auto-scrolling if at the end of the list
6. Expanded view shows full messages without truncation
7. LED status indicator turns red if any error-level entries appear in visible range

## Tasks / Subtasks

- [ ] Create log entry display widget (AC: 2, 3)
  - [ ] Create widget or rich text for single log entry
  - [ ] Format: "HH:MM:SS [SEV] message..."
  - [ ] Apply color based on severity
  - [ ] Truncate message to fit panel width
- [ ] Implement severity color coding (AC: 3)
  - [ ] Red: ERROR, CRITICAL, EMERGENCY, ALERT
  - [ ] Yellow: WARNING
  - [ ] White: INFO, NOTICE
  - [ ] Gray/dim: DEBUG
  - [ ] Define colors in CSS or Rich markup
- [ ] Update LogsPanel with scrollable list (AC: 1, 4)
  - [ ] Update src/monitor_dashboard/panels/logs.py
  - [ ] Add update(entries: list[LogEntry]) method
  - [ ] Use ListView or VerticalScroll for scrolling
  - [ ] Display 30 entries in normal view
  - [ ] Support scrolling to view up to 100 entries
- [ ] Implement auto-scrolling behavior (AC: 5)
  - [ ] Track if user is at bottom of list
  - [ ] Auto-scroll to new entries when at bottom
  - [ ] Do not auto-scroll if user has scrolled up
  - [ ] Handle new entries appearing during refresh
- [ ] Support arrow key navigation (AC: 4)
  - [ ] Up/Down arrows scroll within panel when focused
  - [ ] Ensure scroll position is maintained between refreshes
- [ ] Implement expanded view (AC: 6)
  - [ ] Full messages without truncation
  - [ ] Show more entries (100 instead of 30)
  - [ ] Larger viewing area
- [ ] Implement LED status indicator (AC: 7)
  - [ ] Check visible entries for error-level severity
  - [ ] Red if ERROR/CRITICAL/EMERGENCY/ALERT visible
  - [ ] Yellow if WARNING visible (and no errors)
  - [ ] Green otherwise
- [ ] Integrate with app refresh loop
  - [ ] Call logs_collector.collect()
  - [ ] Call logs_panel.update(entries)

## Dev Notes

**Panel Layout:**
```
┌─ Logs ──────────────────────── ● ─┐
│ 10:30:45 [INF] [drm] GPU reset... │
│ 10:30:46 [INF] usb 1-1: USB dis...│
│ 10:30:47 [ERR] EXT4-fs error: c...│
│ 10:30:48 [WRN] CPU temperature ...│
│ ...                               │
│ [↑↓ to scroll, 100 entries]       │
└───────────────────────────────────┘
```

**Severity Display Abbreviations:**
```python
SEVERITY_ABBREV = {
    LogSeverity.EMERGENCY: "EMG",
    LogSeverity.ALERT: "ALT",
    LogSeverity.CRITICAL: "CRT",
    LogSeverity.ERROR: "ERR",
    LogSeverity.WARNING: "WRN",
    LogSeverity.NOTICE: "NOT",
    LogSeverity.INFO: "INF",
    LogSeverity.DEBUG: "DBG",
}

SEVERITY_COLORS = {
    LogSeverity.EMERGENCY: "red bold",
    LogSeverity.ALERT: "red bold",
    LogSeverity.CRITICAL: "red",
    LogSeverity.ERROR: "red",
    LogSeverity.WARNING: "yellow",
    LogSeverity.NOTICE: "white",
    LogSeverity.INFO: "white",
    LogSeverity.DEBUG: "dim",
}
```

**Log Entry Formatting:**
```python
def format_log_entry(entry: LogEntry, max_width: int = 50) -> Text:
    """Format log entry with color coding."""
    from rich.text import Text

    timestamp = entry.timestamp.strftime("%H:%M:%S")
    abbrev = SEVERITY_ABBREV[entry.severity]
    color = SEVERITY_COLORS[entry.severity]

    # Truncate message if needed
    message = entry.message
    header_len = len(f"{timestamp} [{abbrev}] ")
    available = max_width - header_len
    if len(message) > available:
        message = message[:available-3] + "..."

    text = Text()
    text.append(f"{timestamp} ", style="dim")
    text.append(f"[{abbrev}] ", style=color)
    text.append(message, style=color if entry.severity in ERROR_SEVERITIES else None)

    return text
```

**Auto-Scroll Logic:**
```python
class LogsPanel(BasePanel):
    def __init__(self):
        super().__init__()
        self._at_bottom = True  # Track scroll position

    def on_scroll(self, event):
        """Track if user scrolled away from bottom."""
        scroll = self.query_one("#log-list")
        self._at_bottom = scroll.scroll_y >= scroll.max_scroll_y - 1

    def update(self, entries: list[LogEntry]) -> None:
        scroll = self.query_one("#log-list")
        scroll.remove_children()

        for entry in entries:
            scroll.mount(LogEntryWidget(entry))

        # Auto-scroll if was at bottom
        if self._at_bottom:
            scroll.scroll_end(animate=False)

        self._update_led_status(entries)
```

**LED Status Logic:**
```python
ERROR_SEVERITIES = {
    LogSeverity.EMERGENCY, LogSeverity.ALERT,
    LogSeverity.CRITICAL, LogSeverity.ERROR
}

def _update_led_status(self, entries: list[LogEntry]) -> None:
    # Check visible entries (last 30 for normal view)
    visible = entries[-30:]

    if any(e.severity in ERROR_SEVERITIES for e in visible):
        self._led.status = LEDStatus.CRITICAL
    elif any(e.severity == LogSeverity.WARNING for e in visible):
        self._led.status = LEDStatus.WARNING
    else:
        self._led.status = LEDStatus.OK
```

### Testing

**Test Location:** tests/integration/

**Testing Standards:**
- Framework: pytest with textual pilot API
- Run with: `pytest tests/integration/test_panels.py`

**Test Cases:**
```python
async def test_logs_panel_displays_entries():
    async with app.run_test() as pilot:
        panel = app.query_one(LogsPanel)
        entries = [
            LogEntry(
                timestamp=datetime(2026, 1, 17, 10, 30, 45),
                severity=LogSeverity.INFO,
                message="Test message",
                raw="..."
            )
        ]
        panel.update(entries)

        content = str(panel.render())
        assert "10:30:45" in content
        assert "Test message" in content

async def test_logs_panel_colors_errors_red():
    async with app.run_test() as pilot:
        panel = app.query_one(LogsPanel)
        entries = [
            LogEntry(..., severity=LogSeverity.ERROR, message="Error occurred")
        ]
        panel.update(entries)

        # Check that error styling is applied
        # (Depends on how we query styles)

async def test_logs_panel_led_red_on_error():
    async with app.run_test() as pilot:
        panel = app.query_one(LogsPanel)
        entries = [
            LogEntry(..., severity=LogSeverity.ERROR, ...)
        ]
        panel.update(entries)

        led = panel.query_one(LEDIndicator)
        assert led.status == LEDStatus.CRITICAL
```

**Manual Verification:**
- Launch app and observe log entries
- Generate error (e.g., disconnect USB) and see new entry
- Verify color coding matches severity
- Test scrolling with arrow keys
- Verify auto-scroll behavior

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-17 | 0.1 | Initial story creation | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used

_To be filled by dev agent_

### Debug Log References

_To be filled by dev agent_

### Completion Notes List

_To be filled by dev agent_

### File List

_To be filled by dev agent_

---

## QA Results

_To be filled by QA agent_
