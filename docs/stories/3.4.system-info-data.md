# Story 3.4: System Info Data Collection

## Status

Ready for Review

Approved

## Story

**As a** developer,
**I want** a data collection module that retrieves system information,
**so that** the Info bar can display system details.

## Acceptance Criteria

1. `data_sources/system_info.py` module exists with functions to collect system info
2. Current date/time is retrieved using Python datetime
3. System uptime is retrieved via `psutil.boot_time()` and calculated
4. Kernel version is retrieved from `platform.release()`
5. Distribution info is retrieved from `platform.freedesktop_os_release()` or `/etc/os-release`
6. Module includes unit tests verifying data collection returns expected types

## Tasks / Subtasks

- [x] Create SystemInfo data model (AC: 1)
  - [ ] Create or update src/monitor_dashboard/models/metrics.py
  - [ ] Define SystemInfo dataclass with all fields
  - [ ] Use @dataclass(frozen=True) for immutability
- [x] Create SystemInfoCollector class (AC: 1, 2, 3, 4, 5)
  - [ ] Create src/monitor_dashboard/data_sources/system_info.py
  - [ ] Implement collect() -> SystemInfo method
  - [ ] Gather current datetime
  - [ ] Calculate uptime from boot_time
  - [ ] Get kernel version
  - [ ] Get distro info
- [x] Implement datetime collection (AC: 2)
  - [ ] Use datetime.now() for current time
  - [ ] Return as datetime object for flexible formatting
- [x] Implement uptime calculation (AC: 3)
  - [ ] Use psutil.boot_time() to get boot timestamp
  - [ ] Calculate uptime as current_time - boot_time
  - [ ] Return as timedelta or integer seconds
- [x] Implement kernel version retrieval (AC: 4)
  - [ ] Use platform.release() for kernel version
  - [ ] Handle exceptions gracefully
- [x] Implement distribution info retrieval (AC: 5)
  - [ ] Try platform.freedesktop_os_release() (Python 3.10+)
  - [ ] Fallback: parse /etc/os-release manually
  - [ ] Extract NAME and VERSION_ID
  - [ ] Handle missing distro info gracefully
- [x] Write unit tests (AC: 6)
  - [ ] Create tests/unit/data_sources/test_system_info.py
  - [ ] Test SystemInfo dataclass
  - [ ] Test collect() returns expected types
  - [ ] Test distro fallback parsing
  - [ ] Mock platform and psutil for deterministic tests

## Dev Notes

**Data Model:**
```python
from dataclasses import dataclass
from datetime import datetime, timedelta

@dataclass(frozen=True)
class SystemInfo:
    """Static and semi-static system information."""
    current_time: datetime
    uptime: timedelta
    kernel_version: str
    distro_name: str
    distro_version: str
```

**SystemInfoCollector Pattern:**
```python
import platform
import psutil
from datetime import datetime, timedelta
import logging

logger = logging.getLogger(__name__)

class SystemInfoCollector:
    """Collects system information (datetime, uptime, kernel, distro)."""

    def collect(self) -> SystemInfo:
        """Gather system information.

        Returns:
            SystemInfo with current values.
        """
        return SystemInfo(
            current_time=datetime.now(),
            uptime=self._get_uptime(),
            kernel_version=self._get_kernel(),
            distro_name=self._distro_name,
            distro_version=self._distro_version,
        )

    def _get_uptime(self) -> timedelta:
        """Calculate system uptime."""
        try:
            boot_time = datetime.fromtimestamp(psutil.boot_time())
            return datetime.now() - boot_time
        except Exception as e:
            logger.warning(f"Failed to get uptime: {e}")
            return timedelta(0)

    def _get_kernel(self) -> str:
        """Get kernel version."""
        try:
            return platform.release()
        except Exception as e:
            logger.warning(f"Failed to get kernel version: {e}")
            return "Unknown"

    @property
    def _distro_name(self) -> str:
        """Get distribution name."""
        return self._get_os_release().get('NAME', 'Linux')

    @property
    def _distro_version(self) -> str:
        """Get distribution version."""
        return self._get_os_release().get('VERSION_ID', '')

    def _get_os_release(self) -> dict[str, str]:
        """Get OS release information."""
        # Try freedesktop_os_release (Python 3.10+)
        try:
            return platform.freedesktop_os_release()
        except (AttributeError, OSError):
            pass

        # Fallback: parse /etc/os-release
        try:
            return self._parse_os_release()
        except Exception as e:
            logger.warning(f"Failed to get distro info: {e}")
            return {}

    def _parse_os_release(self) -> dict[str, str]:
        """Parse /etc/os-release file."""
        result = {}
        try:
            with open('/etc/os-release') as f:
                for line in f:
                    line = line.strip()
                    if '=' in line:
                        key, value = line.split('=', 1)
                        # Remove quotes
                        value = value.strip('"\'')
                        result[key] = value
        except FileNotFoundError:
            pass
        return result
```

**Sample /etc/os-release:**
```
NAME="Ubuntu"
VERSION="24.04 LTS (Noble Numbat)"
ID=ubuntu
VERSION_ID="24.04"
PRETTY_NAME="Ubuntu 24.04 LTS"
```

**Caching Consideration:**
Distro info is static, so it can be cached after first read. Kernel version changes only on reboot. Only current_time and uptime need refreshing.

```python
class SystemInfoCollector:
    def __init__(self):
        # Cache static info
        os_release = self._get_os_release()
        self._cached_distro_name = os_release.get('NAME', 'Linux')
        self._cached_distro_version = os_release.get('VERSION_ID', '')
        self._cached_kernel = self._get_kernel()
```

### Testing

**Test Location:** tests/unit/data_sources/

**Testing Standards:**
- Framework: pytest 8.0.0
- Mocking: pytest-mock
- Run with: `pytest tests/unit/data_sources/test_system_info.py`

**Test Patterns:**
```python
from datetime import datetime, timedelta
from unittest.mock import MagicMock, patch, mock_open

def test_collect_returns_system_info(mocker):
    """Test that collect() returns valid SystemInfo."""
    mocker.patch('psutil.boot_time', return_value=1700000000)
    mocker.patch('platform.release', return_value='6.14.0-37-generic')
    mocker.patch('platform.freedesktop_os_release', return_value={
        'NAME': 'Ubuntu',
        'VERSION_ID': '24.04'
    })

    collector = SystemInfoCollector()
    info = collector.collect()

    assert info.kernel_version == '6.14.0-37-generic'
    assert info.distro_name == 'Ubuntu'
    assert info.distro_version == '24.04'
    assert isinstance(info.uptime, timedelta)

def test_get_uptime_calculates_correctly(mocker):
    """Test uptime calculation."""
    # Boot time: 1 hour ago
    boot_timestamp = (datetime.now() - timedelta(hours=1)).timestamp()
    mocker.patch('psutil.boot_time', return_value=boot_timestamp)

    collector = SystemInfoCollector()
    uptime = collector._get_uptime()

    # Should be approximately 1 hour
    assert timedelta(minutes=59) < uptime < timedelta(hours=1, minutes=1)

def test_distro_fallback_to_os_release_file(mocker):
    """Test fallback parsing of /etc/os-release."""
    mocker.patch('platform.freedesktop_os_release', side_effect=AttributeError)

    os_release_content = '''
NAME="Fedora"
VERSION_ID="39"
'''
    mocker.patch('builtins.open', mock_open(read_data=os_release_content))

    collector = SystemInfoCollector()
    info = collector.collect()

    assert info.distro_name == 'Fedora'
    assert info.distro_version == '39'

def test_handles_missing_os_release(mocker):
    """Test graceful handling when /etc/os-release missing."""
    mocker.patch('platform.freedesktop_os_release', side_effect=OSError)
    mocker.patch('builtins.open', side_effect=FileNotFoundError)

    collector = SystemInfoCollector()
    info = collector.collect()

    assert info.distro_name == 'Linux'  # Default fallback
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-17 | 0.1 | Initial story creation | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used

_To be filled by dev agent_

### Debug Log References

_To be filled by dev agent_

### Completion Notes List

_To be filled by dev agent_

### File List

_To be filled by dev agent_

---

## QA Results

_To be filled by QA agent_
